<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Legal Case Classifier</title>
<script src="https://cdn.tailwindcss.com?plugins=forms"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
<style>
    body { font-family: 'Inter', sans-serif; }
    .loader { border: 3px solid #f1f5f9; border-top: 3px solid #4f46e5; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen">

<header class="bg-white border-b border-slate-200 sticky top-0 z-20">
    <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
        <h1 class="text-lg sm:text-xl font-semibold flex items-center gap-2">
            <span class="material-icons text-indigo-600">gavel</span>
            Legal Case Result Predictor
        </h1>
        <a href="#meanings" class="text-sm text-indigo-600 font-medium">Meaning Guide</a>
    </div>
</header>

<main class="max-w-5xl mx-auto px-4 py-8 space-y-6">
    <section class="bg-white border border-slate-200 rounded-xl p-5 sm:p-6">
        <h2 class="text-xl font-semibold">Enter Case Details</h2>
        <p class="text-sm text-slate-600 mt-1">Paste legal text or upload a file. The app will show a predicted legal usage label and confidence.</p>

        <div class="mt-4 flex border border-slate-200 rounded-lg overflow-hidden">
            <button id="tabText" onclick="switchTab('text')" class="flex-1 py-2.5 text-sm font-semibold bg-indigo-50 text-indigo-700">Text Input</button>
            <button id="tabFile" onclick="switchTab('file')" class="flex-1 py-2.5 text-sm font-medium text-slate-600 bg-white">File Upload</button>
        </div>

        <div id="textInputArea" class="mt-4">
            <textarea id="caseInput" class="w-full h-52 p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-200" placeholder="Paste legal text here..."></textarea>
        </div>

        <div id="fileInputArea" class="mt-4 hidden">
            <label for="fileSelector" class="block border-2 border-dashed border-slate-300 rounded-lg p-6 text-center cursor-pointer hover:bg-slate-50">
                <span class="material-icons text-3xl text-indigo-600">upload_file</span>
                <p id="fileNameDisplay" class="mt-2 text-sm font-medium">Click to choose PDF or TXT file</p>
                <input type="file" id="fileSelector" class="hidden" accept=".pdf,.txt" onchange="handleFileSelect(this)">
            </label>
        </div>

        <div class="mt-4 flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
            <div id="statusBox" class="hidden text-sm px-3 py-2 rounded-lg"></div>
            <button id="analyzeBtn" onclick="startAnalysis()" class="px-6 py-2.5 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 inline-flex items-center justify-center gap-2">
                <span id="btnText">Analyze Result</span>
                <span id="btnLoader" class="loader hidden"></span>
            </button>
        </div>
    </section>

    <section id="resultSection" class="hidden bg-white border border-slate-200 rounded-xl p-5 sm:p-6">
        <h2 class="text-xl font-semibold mb-4">Prediction Result</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="border border-slate-200 rounded-lg p-4 bg-slate-50">
                <p class="text-xs text-slate-500">Predicted Label</p>
                <p id="resultLabel" class="text-2xl font-bold mt-1 text-indigo-700">--</p>
                <p id="resultSummary" class="text-sm text-slate-600 mt-2">--</p>
            </div>

            <div class="border border-slate-200 rounded-lg p-4">
                <div class="flex justify-between items-center text-sm">
                    <span class="text-slate-600">Confidence</span>
                    <span id="scoreVal" class="font-semibold">0%</span>
                </div>
                <div class="w-full bg-slate-200 h-3 rounded-full mt-2">
                    <div id="confidenceBar" class="bg-indigo-600 h-3 rounded-full" style="width:0%"></div>
                </div>
                <p class="text-xs text-slate-500 mt-2">Raw score: <span id="rawScore">0.0000</span></p>
            </div>
        </div>

        <div class="mt-4 border border-indigo-100 bg-indigo-50 rounded-lg p-4">
            <p class="text-sm font-semibold text-indigo-800">What this label means</p>
            <p id="meaningText" class="text-sm text-slate-700 mt-1">--</p>
        </div>

        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="border border-slate-200 rounded-lg p-4">
                <p class="text-sm font-semibold">Result Data</p>
                <ul class="text-sm text-slate-700 mt-2 space-y-1">
                    <li>Input type: <span id="detailInputType">-</span></li>
                    <li>Characters: <span id="detailChars">-</span></li>
                    <li>Processed tokens: <span id="detailTokens">-</span></li>
                    <li>Total categories: <span id="detailCategories">-</span></li>
                </ul>
            </div>
            <div class="border border-slate-200 rounded-lg p-4">
                <p class="text-sm font-semibold">Text Preview</p>
                <p id="previewText" class="text-sm text-slate-700 mt-2 leading-relaxed">Preview will appear here after file analysis.</p>
            </div>
        </div>
    </section>

    <section id="meanings" class="bg-white border border-slate-200 rounded-xl p-5 sm:p-6">
        <h2 class="text-xl font-semibold mb-4">Simple Meaning Guide</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
            <div class="border-l-4 border-blue-500 bg-blue-50 p-3 rounded-r-lg">
                <p class="font-semibold text-blue-800">CITED</p>
                <p class="text-slate-700">This case is mentioned as a reference in another judgment.</p>
            </div>
            <div class="border-l-4 border-green-500 bg-green-50 p-3 rounded-r-lg">
                <p class="font-semibold text-green-800">APPLIED</p>
                <p class="text-slate-700">The legal rule from this case is directly used in the current decision.</p>
            </div>
            <div class="border-l-4 border-purple-500 bg-purple-50 p-3 rounded-r-lg">
                <p class="font-semibold text-purple-800">FOLLOWED</p>
                <p class="text-slate-700">The court follows the same reasoning used in this earlier case.</p>
            </div>
            <div class="border-l-4 border-amber-500 bg-amber-50 p-3 rounded-r-lg">
                <p class="font-semibold text-amber-800">REFERRED TO</p>
                <p class="text-slate-700">This case is mentioned for background, not used as the main rule.</p>
            </div>
        </div>
    </section>
</main>

<script>
    let activeTab = 'text';

    function switchTab(tab) {
        activeTab = tab;
        const textBtn = document.getElementById('tabText');
        const fileBtn = document.getElementById('tabFile');
        const textArea = document.getElementById('textInputArea');
        const fileArea = document.getElementById('fileInputArea');

        if (tab === 'text') {
            textBtn.className = 'flex-1 py-2.5 text-sm font-semibold bg-indigo-50 text-indigo-700';
            fileBtn.className = 'flex-1 py-2.5 text-sm font-medium text-slate-600 bg-white';
            textArea.classList.remove('hidden');
            fileArea.classList.add('hidden');
        } else {
            fileBtn.className = 'flex-1 py-2.5 text-sm font-semibold bg-indigo-50 text-indigo-700';
            textBtn.className = 'flex-1 py-2.5 text-sm font-medium text-slate-600 bg-white';
            fileArea.classList.remove('hidden');
            textArea.classList.add('hidden');
        }
    }

    function handleFileSelect(input) {
        if (input.files && input.files[0]) {
            document.getElementById('fileNameDisplay').innerText = input.files[0].name;
        }
    }

    function showStatus(message, type='info') {
        const box = document.getElementById('statusBox');
        box.className = 'text-sm px-3 py-2 rounded-lg';
        if (type === 'error') {
            box.classList.add('bg-red-50', 'text-red-700', 'border', 'border-red-200');
        } else if (type === 'success') {
            box.classList.add('bg-green-50', 'text-green-700', 'border', 'border-green-200');
        } else {
            box.classList.add('bg-slate-100', 'text-slate-700', 'border', 'border-slate-200');
        }
        box.textContent = message;
        box.classList.remove('hidden');
    }

    function clearStatus() {
        const box = document.getElementById('statusBox');
        box.classList.add('hidden');
        box.textContent = '';
    }

    function updateMeaning(label, apiMeaning) {
        if (apiMeaning) return apiMeaning;
        const meanings = {
            cited: 'This case is mentioned as a reference in another case.',
            applied: 'This case rule is directly used to decide the current case.',
            followed: 'The court follows the same reasoning used in this case.',
            'referred to': 'This case is mentioned for background context.'
        };
        return meanings[label] || 'This label shows how this case is used in legal judgments.';
    }

    function renderResult(data) {
        const scorePct = Math.max(0, Math.min(100, Math.round((Number(data.score) || 0) * 100)));
        const labelText = (data.label || 'unknown').toUpperCase();
        const details = data.result_details || {};

        document.getElementById('resultLabel').innerText = labelText;
        document.getElementById('resultSummary').innerText = data.result_summary || `Prediction: ${labelText}`;
        document.getElementById('scoreVal').innerText = `${scorePct}%`;
        document.getElementById('rawScore').innerText = (Number(data.score) || 0).toFixed(4);
        document.getElementById('confidenceBar').style.width = `${scorePct}%`;
        document.getElementById('meaningText').innerText = updateMeaning((data.label || '').toLowerCase(), data.label_meaning);

        document.getElementById('detailInputType').innerText = details.input_type || '-';
        document.getElementById('detailChars').innerText = details.input_characters ?? '-';
        document.getElementById('detailTokens').innerText = details.processed_tokens ?? '-';
        document.getElementById('detailCategories').innerText = details.total_categories ?? (data.all_categories ? data.all_categories.length : '-');

        document.getElementById('previewText').innerText = data.text_preview || 'No preview for direct text input.';
        document.getElementById('resultSection').classList.remove('hidden');
    }

    async function startAnalysis() {
        const btnText = document.getElementById('btnText');
        const loader = document.getElementById('btnLoader');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const resultSection = document.getElementById('resultSection');

        clearStatus();
        resultSection.classList.add('hidden');
        btnText.innerText = 'Analyzing...';
        loader.classList.remove('hidden');
        analyzeBtn.disabled = true;

        try {
            let response;
            if (activeTab === 'text') {
                const text = document.getElementById('caseInput').value.trim();
                if (!text) {
                    showStatus('Please enter legal text first.', 'error');
                    return;
                }
                response = await fetch('/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });
            } else {
                const file = document.getElementById('fileSelector').files[0];
                if (!file) {
                    showStatus('Please choose a PDF or TXT file first.', 'error');
                    return;
                }
                const formData = new FormData();
                formData.append('file', file);
                response = await fetch('/upload', { method: 'POST', body: formData });
            }

            const data = await response.json();
            if (!response.ok || data.error) {
                showStatus(data.error || 'Analysis failed. Please try again.', 'error');
                return;
            }

            renderResult(data);
            showStatus('Done! Result generated successfully.', 'success');
            resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        } catch (e) {
            showStatus('Network/server error. Please try again.', 'error');
        } finally {
            btnText.innerText = 'Analyze Result';
            loader.classList.add('hidden');
            analyzeBtn.disabled = false;
        }
    }
</script>
</body>
</html>
